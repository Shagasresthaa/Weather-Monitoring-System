#include "DHT.h"
#include <Arduino.h>
#include <U8g2lib.h>
#ifdef U8X8_HAVE_HW_SPI
#include <SPI.h>
#endif
#ifdef U8X8_HAVE_HW_I2C
#include <Wire.h>
#endif

#define DHTPIN PB4   
#define DHTTYPE DHT22 

int UVOUT = PA0; //Output from the sensor
int REF_3V3 = PA1; //3.3V power on the STM32 Board

//Logo Bitmap Byte Array
#pragma once
#define JS2HF5_BMPWIDTH  80
#define JS2HF5_BMPHEIGHT  35

static const unsigned char bitmap_js2hf5[] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xf7, 0xff, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x68, 0x3f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xf8, 0x00, 0x1f, 
  0xc0, 0x00, 0x00, 0x00, 0x00, 0x01, 0xe0, 0x07, 0x80, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x00, 0xff, 
  0x00, 0x00, 0xe0, 0x0f, 0xc0, 0x00, 0x00, 0x00, 0x07, 0x8c, 0x00, 0x00, 0x38, 0x07, 0xe0, 0x00, 
  0x00, 0x00, 0x0c, 0x08, 0x00, 0x00, 0x7f, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x18, 0x10, 0x00, 0x01, 
  0x81, 0xe1, 0xc0, 0x00, 0x00, 0x00, 0x68, 0x00, 0x00, 0x04, 0x00, 0x38, 0xc0, 0x00, 0x00, 0x01, 
  0xf8, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x03, 0x18, 0x00, 0x00, 0x00, 0x00, 0x07, 
  0x00, 0x00, 0x00, 0x06, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 
  0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x01, 0x80, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x04, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 
  0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x00, 
  0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

//Logo Bitmap Byte Array Ends

//U8G2_SSD1306_128X64_NONAME_F_HW_I2C u8g2(U8G2_R0, /* reset=*/ U8X8_PIN_NONE); //For SSD1306 driver oled
U8G2_SH1106_128X64_NONAME_F_HW_I2C u8g2(U8G2_R0, LED_BUILTIN);
DHT dht(DHTPIN, DHTTYPE);

void setup() {
  //DHT22 init
  Serial.begin(9600);
  Serial.println(F("DHTxx test!"));
  dht.begin();

  //UV Sensor Init
  Serial.begin(9600);
  pinMode(UVOUT, INPUT);
  pinMode(REF_3V3, INPUT);
  Serial.println("ML8511 example");

  //U8G2 init
  u8g2.begin();
  u8g2.enableUTF8Print();
  u8g2.setFontDirection(0);
  displayLogo();
}

//Shows logo on bootup
void displayLogo(){
  u8g2.clearDisplay();
  u8g2.drawBitmap(25, 0, JS2HF5_BMPWIDTH/8, JS2HF5_BMPHEIGHT, bitmap_js2hf5);
  u8g2.setCursor(0, 50);
  u8g2.setFont(u8g2_font_unifont_t_latin);             
  u8g2.print("Weather Node V6");
  u8g2.sendBuffer();
  delay(3500);
}

int averageAnalogRead(int pinToRead)
{
  byte numberOfReadings = 8;
  unsigned int runningValue = 0; 
 
  for(int x = 0 ; x < numberOfReadings ; x++)
    runningValue += analogRead(pinToRead);
  runningValue /= numberOfReadings;
 
  return(runningValue);
}
 
float mapfloat(float x, float in_min, float in_max, float out_min, float out_max)
{
  return (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
}

void loop() {
  float h = dht.readHumidity();
  // Read temperature as Celsius (the default)
  float t = dht.readTemperature();
  // Read temperature as Fahrenheit (isFahrenheit = true)
  float f = dht.readTemperature(true);
  
  int uvLevel = averageAnalogRead(UVOUT);
  int refLevel = averageAnalogRead(REF_3V3);
  float outputVoltage = 3.3 / refLevel * uvLevel;
  float uvIntensity = mapfloat(outputVoltage, 0.99, 2.8, 0.0, 15.0); //Convert the voltage to a UV intensity level
  Serial.print(" / UV Intensity (mW/cm^2): ");
  Serial.println(uvIntensity);

  // Check if any reads failed and exit early (to try again).
  if (isnan(h) || isnan(t) || isnan(f)) {
    Serial.println(F("Failed to read from DHT sensor!"));
    return;
  }

  // Compute heat index in Celsius (isFahreheit = false)
  float hic = dht.computeHeatIndex(t, h, false);

  //Display on oled Display
  u8g2.clearBuffer();
  u8g2.setCursor(0, 10);                   //text position (left botom corner)
  u8g2.setFont(u8g2_font_unifont_t_latin); //first font             
  u8g2.print("Temp: ");
  u8g2.print(t);
  u8g2.println("°C");
  
  u8g2.setCursor(0, 25); 
  u8g2.print("Humd: ");
  u8g2.print(h);
  u8g2.println("%");
  
  u8g2.setCursor(0, 40); 
  u8g2.print("HIdx: ");
  u8g2.print(hic);
  u8g2.println("°C");
    
  u8g2.setCursor(0, 55); 
  u8g2.print("UVIN: ");
  u8g2.print(uvIntensity);
  u8g2.println("mW/cm²");
  u8g2.sendBuffer();

  delay(2000);
}
